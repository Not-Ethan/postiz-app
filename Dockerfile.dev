FROM node:20-alpine3.19
ARG NEXT_PUBLIC_VERSION
ENV NEXT_PUBLIC_VERSION=$NEXT_PUBLIC_VERSION

# Add necessary build tools and openssl for Prisma
RUN apk add --no-cache g++ make py3-pip bash nginx openssl

# Install pnpm and pm2 globally
RUN npm --no-update-notifier --no-fund --global install pnpm@10.6.1 pm2

WORKDIR /app

# Copy only the files needed for dependency installation to leverage Docker caching
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc ./
COPY apps/backend/package.json ./apps/backend/
COPY apps/frontend/package.json ./apps/frontend/
COPY apps/cron/package.json ./apps/cron/
COPY apps/commands/package.json ./apps/commands/
COPY apps/extension/package.json ./apps/extension/
COPY apps/sdk/package.json ./apps/sdk/
COPY apps/workers/package.json ./apps/workers/
COPY libraries/nestjs-libraries/package.json ./libraries/nestjs-libraries/
COPY libraries/react-shared-libraries/package.json ./libraries/react-shared-libraries/

# Install dependencies. This layer will be cached as long as package files don't change.
RUN pnpm install --frozen-lockfile

# Now copy the rest of the application source code
COPY . .

# Copy nginx config
COPY var/docker/nginx.conf /etc/nginx/nginx.conf

# Explicitly run prisma generate to ensure the correct binaries are available
RUN pnpm run prisma-generate

# Build the application
RUN NODE_OPTIONS="--max-old-space-size=4096" pnpm run build

# Set up user and permissions
RUN adduser -D -g 'www' www
RUN mkdir /www
RUN chown -R www:www /var/lib/nginx
RUN chown -R www:www /www

CMD ["sh", "-c", "nginx && pnpm run pm2"]
